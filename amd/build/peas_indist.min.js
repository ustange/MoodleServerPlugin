define(["jquery","local_eexcess/util","local_eexcess/graph"],function(a,b,c){function d(a,c,d){var e=new Array,f=a.length,g=3,h=Math.floor(Math.random()*g)+1;if(randomNumber=1,1==h){var i=j(f);if(i.length>0)for(var m=Math.floor(Math.random()*i.length),n=i[m],p=0;p<a.length;p++){var q=new Object;q.text=n._vertices[p],q.weight=a[p].weight,e[p]=q}else h=2}if(2==h){var i=k(f);if(i.length>0)for(var m=Math.floor(Math.random()*i.length),n=i[m],p=0;p<a.length;p++){var q=new Object;q.text=n._vertices[p],q.weight=a[p].weight,e[p]=q}else h=3}if(3==h){var r=l();if(r.length>=f)for(var p=0;f>p;){var q=new Object,s=Math.floor(Math.random()*r.length);b.contains(o(e),r[s])||(q.text=r[s],q.weight=a[p].weight,e[p]=q,p++)}}return e}function e(a,c){for(var d=0,e=a.result,f=c.length,g=e.length,h=0;g>h;h++){for(var i=e[h],j=0,k=0;f>k;k++){var l=c[k],m=0;void 0!=i.title&&(m+=b.nbInstances(i.title,l.text)),void 0!=i.description&&(m+=b.nbInstances(i.description,l.text)),j+=m}d+=j}return d}function f(){var a=(null!=localStorage.getItem(z),!0),c=localStorage.getItem(A);null!=c&&(a=b.before(new Date(c),b.yesterday()));h()}function g(){var a=null!=localStorage.getItem(x),c=!0,d=localStorage.getItem(y);if(null!=d&&(c=b.before(new Date(d),b.yesterday())),!a||c)C=i();else for(var e=JSON.parse(localStorage.getItem(x)),f=0;f<e.length;f++)C[f]=p(e[f])}function h(){a.ajax({url:t}).success(function(a){B=p(a),localStorage.setItem(z,JSON.stringify(a)),localStorage.setItem(A,new Date)})}function i(){a.ajax({url:v}).success(function(a){C=new Array;for(var b=new Array,c=0;c<a.length;c++){var d=a[c];C[c]=p(d),b[c]=d}localStorage.setItem(x,JSON.stringify(b)),localStorage.setItem(y,new Date)})}function j(a){for(var b=new Array,c=0;c<C.length;c++){var d=C[c];d.order()==a&&(b[b.length]=d)}return b}function k(a){for(var b=new Array,c=0;c<C.length;c++){var d=C[c];d.order()>a&&(b[b.length]=d)}return b}function l(){for(var a=new Array,b=0;b<B.order();b++){var c=B._vertices[b];a[b]=c}return a}function m(a){for(var b=Number.MAX_VALUE,c=new Array,d=0;d<a.length;d++)c[d]=a[d].text;for(var d=0;d<c.length;d++)for(var e=d+1;e<c.length;e++){var f=B.get(c[d],c[e]);void 0!=f?b>f&&(b=f):b=0}return b}function n(a){var b=new Object,c=a-q/2,d=a;return b.lowerBound=Math.floor(Math.random()*(d+1-c)+c),b.upperBound=b.lowerBound+q,b}function o(a){for(var b=new Array,c=0;c<a.length;c++)b[c]=a[c].text;return b}function p(a){for(var b=new Graph,c=0;c<a.length;c++)for(var d=a[c].term,e=a[c].frequencies,f=0;f<e.length;f++){var g=e[f].term,h=e[f].frequency;b.set(d,g,h)}return b}var q=2,r="https://eexcess-dev.joanneum.at/eexcess-privacy-proxy-issuer-1.0-SNAPSHOT/issuer/",s="getCoOccurrenceGraph",t=r+s,u="getMaximalCliques",v=r+u,w="peas.",x=w+"mcs",y=w+"mcs.lastUpdate",z=w+"cog",A=w+"cog.lastUpdate",B=new Graph;f();var C=[];g();var D={init:function(a){t=a+s,v=a+u,f(),g()},obfuscateQuery:function(a,c){for(var e=a,f=[],g=[],h=a.contextKeywords,i=(h.length,m(h)),j=n(i),k=b.merge(o(h),g),l=0,p=10*c;c>l&&p>0;){var q=d(h,j.lowerBound,j.upperBound);0==q.length?p=0:b.intersect(k,o(q))||(f[l]=q,l++,k=b.merge(k,o(q))),p--}if(f[f.length]=a.contextKeywords,f.length>1){var r=Math.floor(Math.random()*f.length);if(r!=c){var s=f[r];f[r]=f[c],f[c]=s}}return e.contextKeywords=f,e},filterResults:function(a,b){for(var c=a.results,d=-1,f=[],g=0;g<c.length;g++){var h=c[g],i=e(h,b.contextKeywords);i>d&&(d=i,f=h)}var j=f;return j.totalResults=f.result.length,j.queryID=a.queryID,j}};return D});