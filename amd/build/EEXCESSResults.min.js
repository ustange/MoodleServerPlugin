define(["jquery","local_eexcess/APIconnector","local_eexcess/iframes","local_eexcess/md5","local_eexcess/paragraphDetection"],function(a,b,c,d,e){function f(a,b){return d.getHash(a+b)}var g,h=!1,i=void 0,j=void 0,k=void 0,l={},m={module:"EEXCESS - Moodle Plugin searchBar",clientType:"EEXCESS - Moodle Plugin",clientVersion:"1.0",userID:"undefined"},n=a('<div class = "search-bar-div">'),o=a("<iframe>"),p="",q=null,r={init:function(a,c,d,e){i=e,j=c,m.userID=f(m.clientType,j),b.init({origin:m}),k=d,p="https://cdn.rawgit.com/ustange/c4-for-moodle-plugin/master/examples/searchBar_Paragraphs/index.html",r._bindControls(),r._createUI()},_createUI:function(){n.appendTo(a("body")),n.append(o),o.attr("src",p),o.attr("class","search-bar")},_bindControls:function(){a("body").on("mouseup",function(b){var c=a(b.target),d=c.parents(".editor_atto_content").length||c.hasClass("editor_atto_content"),e=r._getSelectionText();e&&e.length>3&&!d&&r._query(e)}),window.addEventListener("message",function(a){a.data.event&&(a.data.data&&(a.data.data.origin=m),"eexcess.paragraphEnd"===a.data.event?r._query(a.data.text):"eexcess.newSelection"===a.data.event||"eexcess.queryTriggered"===a.data.event||("attoEditorOpened"===a.data.event?(c.sendMsgAll({event:"attoEditorOpened",data:""}),h=!0):"eexcess.error"===a.data.event||("eexcess.searchBarhei"===a.data.event?(g=a.data.data,600==n[0].clientHeight?(n.css("height","600px"),h&&c.sendMsgAll({event:"attoEditorOpened",data:""})):(n.css("height",g+"px"),h&&c.sendMsgAll({event:"attoEditorOpened",data:""}))):"eexcess.openResultsBar"===a.data.event?n.css("height","600px"):"eexcess.closeResultsBar"===a.data.event?n.css("height",g+"px"):"dashboardOpened"===a.data.event?h?(c.sendMsgAll({event:"attoEditorOpened",data:""}),c.sendMsgAll({event:"eexcess.newDashboardSettings",settings:{selectedChart:"timeline",hideCollections:!1,showLinkImageButton:!0,showLinkItemButton:!0,showScreenshotButton:!0,origin:m}})):c.sendMsgAll({event:"eexcess.newDashboardSettings",settings:{selectedChart:"timeline",hideCollections:!1,showLinkImageButton:!1,showLinkItemButton:!1,showScreenshotButton:!1,origin:m}}):"facetScapeOpened"===a.data.event?h&&c.sendMsgAll({event:"attoEditorOpened",data:""}):"searchBarOpened"===a.data.event?(c.sendMsgAll({event:"interests",data:i}),l.origin=m,l.baseUrl=k,c.sendMsgAll({event:"apiSettings",data:l})):"eexcess.rating"===a.data.event||"eexcess.linkItemClicked"===a.data.event||("eexcess.log.itemCitedAsImage"===a.data.event?b.sendLog(b.logInteractionType.itemCitedAsImage,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemCitedAsText"===a.data.event?b.sendLog(b.logInteractionType.itemCitedAsText,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemCitedAsHyperlink"===a.data.event&&b.sendLog(b.logInteractionType.itemCitedAsHyperlink,a.data.data,function(a){window.console.log(a)})))))})},_query:function(a){e.paragraphToQuery(a,function(b){q=b.query&&b.query.contextKeywords.length>0?{contextKeywords:b.query.contextKeywords}:{contextKeywords:[{text:a,weight:1}]},q.origin=m,c.sendMsgAll({event:"eexcess.queryTriggered",data:q})})},_getSelectionText:function(){var a="";return window.getSelection?a=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(a=document.selection.createRange().text),a}};return{init:r.init}});