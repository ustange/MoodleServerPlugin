define(["jquery","block_eexcess/namedEntityRecognition"],function(a,b){var c=[],d={prefix:"eexcess",classname:"eexcess_detected_par"},e=function(a){"undefined"==typeof a&&(a=document.body);for(var b=[],c=document.createTreeWalker(a,NodeFilter.SHOW_TEXT),d=c.nextNode();d;){var e=d.nodeValue.search(/\S+/),f=d.parentNode.nodeName,g="SCRIPT"!==f,h="STYLE"!==f,i="NOSCRIPT"!==f,j=d.nodeValue.length>40;-1!==e&&g&&h&&i&&j?(-1===b.indexOf(d.parentNode)&&b.push(d.parentNode),c.currentNode=d.parentNode,d=c.nextSibling()):d=c.nextNode()}return b},f=function(a){var b=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT),c=a;for(b.currentNode=c;c=b.previousNode();)if(0===c.nodeName.indexOf("H"))return c;return null},g=function(b,c){for(var e="",g=0;g<b.length;g++)e+=a(b[g]).text();return a(b).wrapAll('<div id="'+d.prefix+"_par_"+c+'" data-idx="'+c+'" class="'+d.classname+'"></div>'),{elements:b,headline:a(f(b[0])).text(),content:e,multi:b.length>1,id:d.prefix+"_par_"+c}},h={setTimer:function(a,b){"undefined"==typeof b&&(b=100),this.callback=a,this.timeoutID=window.setTimeout(a,b)},clearTimer:function(){window.clearTimeout(this.timeoutID),delete this.timeoutID}};return{init:function(b){d=a.extend(d,b)},getSettings:function(){return d},getParagraphs:function(b){"undefined"==typeof b&&(b=document);for(var d=e(b),f=[],h=0,i=0;i<d.length;i++){for(var j=d[i].nextSibling,k=!0,l=i,m=[];null!==j;)if("#text"!==j.nodeName){var n=a.inArray(j,d,l);n>-1?(l=n,m.push(d[l]),k=!1,j=j.nextSibling):j=null}else j=j.nextSibling;if(k){var o=a(d[i]).text();o.length>100&&o.indexOf(".")>-1&&(f.push(g([d[i]],h)),h++)}else m.unshift(d[i]),f.push(g(m,h)),h++,i=l}return c=f,f},paragraphToQuery:function(c,d,e,f){"undefined"==typeof e&&(e=1),"undefined"==typeof f&&(f="");var g=[{id:e,headline:f,content:c}];b.entitiesAndCategories(g,function(b){if("success"===b.status){var c={contextKeywords:[]};if(b.data.paragraphs[0].topic&&"undefined"!=typeof b.data.paragraphs[0].topic&&"undefined"!=typeof b.data.paragraphs[0].topic.text){var e={text:b.data.paragraphs[0].topic.text,uri:b.data.paragraphs[0].topic.entityUri,type:b.data.paragraphs[0].topic.type,isMainTopic:!0};c.contextKeywords.push(e)}a.each(b.data.paragraphs[0].statistic,function(){this.key.text!==e.text&&c.contextKeywords.push({text:this.key.text,uri:this.key.entityUri,type:this.key.type,isMainTopic:!1})}),d({query:c})}else d({error:b.data})})},getSelection:function(b){var c={selection:document.getSelection().toString()};if("undefined"!=typeof b&&c.selection.length>0){var e=a(window.getSelection().getRangeAt(0).commonAncestorContainer).parents("."+d.classname);if(1===e.length){var f=e[0].dataset.idx;f&&f<b.length&&e[0].id===b[f].id&&b[f].entities&&(c.entities=b[f].entities)}else e.length>1&&console.log("multiple paragraphs")}return c},augmentLinks:function(b,c,d,e,f){var g=a('<img src="'+c+'" style="cursor:pointer;width:30px;" />');g.click(function(){var b={contextKeywords:[{weight:1,text:a(this).data("query")}]};if("undefined"!=typeof f){var c=a(this).data("paragraphID"),e=a(this).data("idx");f[e].id===c&&(b.contextNamedEntities=f[e].entities)}d(b)}).hover(function(){h.clearTimer()},function(){a(this).hide()}).css("position","absolute").css("z-index",9999).mouseleave(function(){a(this).hide()}).hide(),a("body").append(g);var i=25,j=-2;b.find("a").each(function(){var b=a(this);if(b.text().length>3){var c=a('<div style="display:inline;"></div>');c.mouseenter(function(c){console.log("mouseenter");var d=b.parents("."+e);h.clearTimer(),g.data("query",b.text()),g.data("paragraphID",d[0].id),g.data("idx",d[0].dataset.idx);var f=a(this),k=f.offset();g.css("top",k.top-f.height()+j+"px").css("left",k.left-i+"px").show()}),c.mouseleave(function(){h.setTimer(function(){g.hide()})}),b.wrap(c)}})},findFocusedParagraph:function(b){function d(){a(c).each(function(){var b=0,c=0;a(this.elements).each(function(){a(this).width()>b&&(b=a(this).width()),c+=a(this).height()}),this.area=b*c,this.area>q&&(q=this.area)}),a(c).each(function(){this.sizeRelation=this.area/q})}function e(b){var c=new Set,d=a(window).scrollTop()+a(window).height();return a(b).each(function(){var b=a(this.elements[0]).offset().top;d>b&&b>a(window).scrollTop()&&(this.cursorDistance=0,c.add(this))}),c}function f(){var a,b=0;r.forEach(function(c){c.pGotRead=l*c.sizeRelation+m*c.distance+n*c.cursorDistance,c.pGotRead>b&&(b=c.pGotRead,a=c)});var c=new CustomEvent("paragraphFocused",{detail:a});document.dispatchEvent(c)}function g(){r.forEach(function(b){var c=a(b.elements[0]).offset(),d=c.left-a(window).scrollLeft(),e=c.top-a(window).scrollTop();0>e&&(e=a(window).height());var f=Math.sqrt(d*d+e*e);b.distance=1-f/p})}function h(b,c){r.forEach(function(d){var e={x:0,y:0},f=a(d.elements[0]).offset(),g=0,h=0;a(d.elements).each(function(){g+=a(this).height(),h<a(this).width()&&(h=a(this).width())}),e.y=f.top+g,e.x=f.left,d.cursorDistance=1-Math.sqrt(Math.pow(e.x-b,2)+Math.pow(e.y-c,2))/p})}var i,j,k,l=.1,m=1,n=3,o=0,p=Math.sqrt(a(window).height()*a(window).height()+a(window).width()*a(window).width()),q=0;"undefined"!=typeof b&&(c=b),d();var r=e(c);g(),h(0,0),f(),a(document).scroll(function(a){clearTimeout(i),i=setTimeout(function(){n=.2,r=e(c),g(),f()},100)}),a(document).mousemove(function(a){clearTimeout(k),o++,k=setTimeout(function(){o>10&&(n=3,h(a.pageX,a.pageY),f()),o=0},100)}),a(window).resize(function(){clearTimeout(j),j=setTimeout(function(){p=Math.sqrt(a(window).height()*a(window).height()+a(window).width()*a(window).width()),d(),r=e(c),g(),f()},100)})},findFocusedParagraphSimple:function(b){function d(){var a,b;h.forEach(function(c){c.pGotRead=c.distance,(!a||c.pGotRead<a)&&(a=c.pGotRead,b=c)});var c=new CustomEvent("paragraphFocused",{detail:b});document.dispatchEvent(c)}function e(b){var c=new Set,d=a(window).scrollTop()+a(window).height();return a(b).each(function(){var b=a(this.elements[0]).offset().top;d>b&&b>a(window).scrollTop()&&c.add(this)}),c}function f(){h.forEach(function(b){var c=a(b.elements[0]).offset(),d=c.left-a(window).scrollLeft(),e=c.top-a(window).scrollTop();b.distance=Math.sqrt(d*d+e*e)})}var g;"undefined"!=typeof b&&(c=b),a.each(c,function(){var b=this;a(this.elements[0]).parent().click(function(a){var c=new CustomEvent("paragraphFocused",{detail:b});document.dispatchEvent(c)})});var h=e(c);f(),d(),a(document).scroll(function(a){clearTimeout(g),g=setTimeout(function(){h=e(c),f(),d()},100)})}}});